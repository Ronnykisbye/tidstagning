/* ======================================================
   AFSNIT 15 ‚Äì POPUP SLETNING (JS)
   ------------------------------------------------------
   Dette afsnit indeholder:
   15.1 ‚Äì Funktion til at √•bne popup
   15.2 ‚Äì Funktion til at lukke popup
   15.3 ‚Äì Funktion til at slette opgave efter godkendelse
   15.4 ‚Äì Auto-generering af popup-element i DOM
   ====================================================== */


/* ------------------------------------------------------
   15.1 ‚Äì VIS POPUP (id = opgave der skal slettes)
   ------------------------------------------------------ */
function showDeletePopup(planId) {
    // Find popup-elementer
    const overlay = document.getElementById("deleteModalOverlay");
    const delBtn  = document.getElementById("confirmDeleteBtn");

    if (!overlay || !delBtn) return;

    // Gem id'et p√• knappen (smart og simpelt)
    delBtn.dataset.planId = planId;

    // Vis popup
    overlay.classList.add("visible");
}


/* ------------------------------------------------------
   15.2 ‚Äì LUK POPUP
   ------------------------------------------------------ */
function closeDeletePopup() {
    const overlay = document.getElementById("deleteModalOverlay");
    if (overlay) {
        overlay.classList.remove("visible");
    }
}


/* ------------------------------------------------------
   15.3 ‚Äì K√òR SLETNING EFTER GODKENDELSE
   ------------------------------------------------------ */
function confirmDeleteAction() {
    const delBtn = document.getElementById("confirmDeleteBtn");
    if (!delBtn) return;

    const planId = delBtn.dataset.planId;
    if (!planId) return;

    // Selve sletningen
    deletePlanItem(planId);

    // Luk popup
    closeDeletePopup();
}


/* ------------------------------------------------------
   15.4 ‚Äì AUTO-OPRET MODAL I DOM (kun 1 gang)
   ------------------------------------------------------ */
(function createDeleteModal() {
    if (document.getElementById("deleteModalOverlay")) return;

    const div = document.createElement("div");
    div.id = "deleteModalOverlay";
    div.className = "modal-overlay";

    div.innerHTML = `
        <div class="modal-box">
            <div class="modal-title">Bekr√¶ft sletning</div>
            <div class="modal-message">Er du sikker p√•, at du vil slette denne opgave?</div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="cancelDeleteBtn">Fortryd</button>
                <button class="modal-btn modal-btn-delete" id="confirmDeleteBtn">Slet</button>
            </div>
        </div>
    `;

    document.body.appendChild(div);

    // Event listeners
    document.getElementById("cancelDeleteBtn").addEventListener("click", closeDeletePopup);
    document.getElementById("confirmDeleteBtn").addEventListener("click", confirmDeleteAction);
})();


/* ======================================================
   AFSNIT 08 ‚Äì PLAN VISNING (DASHBOARD-LIGNENDE)
   ====================================================== */

function renderPlans() {
    const list = document.getElementById("allPlansList");
    if (!list) return;

    list.innerHTML = "";

    plans.forEach(p => {
        const li = document.createElement("li");
        li.className = "plan-item";

        const customerName = getCustomerName(p.customerId);
        const employeesNames = (p.employeeIds || [])
            .map(getEmployeeName)
            .filter(Boolean)
            .join(", ");

        li.innerHTML = `
            <span>
                ${p.date} ‚Äì ${customerName}
                ${employeesNames ? " (" + employeesNames + ")" : ""}
                ${p.note ? " ‚Äì " + p.note : ""}
            </span>
            <button class="plan-delete-btn" data-id="${p.id}">üóëÔ∏è</button>
        `;

        li.querySelector(".plan-delete-btn").addEventListener("click", () => {
            showDeletePopup(p.id);
        });

        list.appendChild(li);
    });
}


/* ======================================================
   AFSNIT 09 ‚Äì KALENDER GENERERING
   ====================================================== */

function renderCalendar() {
    const grid = document.getElementById("calendarGrid");
    if (!grid) return;

    grid.innerHTML = "";

    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth();

    const first = new Date(y, m, 1);
    const last = new Date(y, m + 1, 0);
    const daysInMonth = last.getDate();
    const startDay = first.getDay() === 0 ? 7 : first.getDay();

    // Tomme felter f√∏r 1.
    for (let i = 1; i < startDay; i++) {
        const empty = document.createElement("div");
        empty.className = "calendar-cell calendar-empty";
        grid.appendChild(empty);
    }

    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${y}-${String(m+1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
        const dayPlans = plans.filter(p => p.date === dateStr);

        const cell = document.createElement("div");
        cell.className = "calendar-cell";
        cell.textContent = d;

        // Farver baseret p√• antal opgaver
        if (dayPlans.length === 0) {
            cell.classList.add("calendar-day-empty");
        } else if (dayPlans.length <= 3) {
            cell.classList.add("calendar-day-medium");
        } else {
            cell.classList.add("calendar-day-busy");
        }

        // Klik: v√¶lg dag
        cell.addEventListener("click", () => {
            selectedCalendarDate = dateStr;
            renderDayDetails(dateStr);
        });

        grid.appendChild(cell);
    }
}


/* ======================================================
   AFSNIT 10 ‚Äì HELPER: LOKALISERING FOR SPROG
   ====================================================== */

function getLocaleForLang(lang) {
    switch (lang) {
        case "dk": return "da-DK";
        case "gb": return "en-GB";
        case "de": return "de-DE";
        case "lt": return "lt-LT";
        default: return "da-DK";
    }
}


/* ======================================================
   AFSNIT 11 ‚Äì SLET OPGAVE (NY FUNKTION)
   ====================================================== */

function deletePlanItem(id) {
    plans = plans.filter(p => p.id !== id);
    saveAll();
    renderCalendar();
    renderDayDetails(selectedCalendarDate);
    renderPlans();
}


/* ======================================================
   AFSNIT 12 ‚Äì RENDER DAGENS OPGAVER (NY VERSION)
   ====================================================== */

function renderDayDetails(dateStr) {
    const label = document.getElementById("selectedDayLabel");
    const list  = document.getElementById("dayPlanList");
    if (!label || !list) return;

    if (!dateStr) {
        label.textContent = "V√¶lg en dag";
        list.innerHTML = "";
        return;
    }

    const locale = getLocaleForLang(currentLang);
    const d = parseDateString(dateStr);

    label.textContent = d.toLocaleDateString(locale, {
        weekday: "short",
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
    });

    const dayPlans = plans.filter(p => p.date === dateStr);
    list.innerHTML = "";

    if (!dayPlans.length) {
        const li = document.createElement("li");
        li.textContent = "Ingen opgaver for denne dag.";
        list.appendChild(li);
        return;
    }

    dayPlans.forEach(p => {
        const li = document.createElement("li");
        li.style.display = "flex";
        li.style.justifyContent = "space-between";
        li.style.alignItems = "center";

        const customerName = getCustomerName(p.customerId);
        const employeesNames = (p.employeeIds || [])
            .map(getEmployeeName)
            .filter(Boolean)
            .join(", ");

        const infoSpan = document.createElement("span");
        infoSpan.textContent =
            `${customerName}` +
            (employeesNames ? ` (${employeesNames})` : "") +
            (p.note ? ` ‚Äì ${p.note}` : "");

        const delBtn = document.createElement("button");
        delBtn.className = "delete-plan-btn";
        delBtn.textContent = "üóëÔ∏è";
        delBtn.addEventListener("click", () => showDeletePopup(p.id));

        li.appendChild(infoSpan);
        li.appendChild(delBtn);
        list.appendChild(li);
    });
}


/* ======================================================
   AFSNIT 13 ‚Äì SPROGSKIFT (UBER√òRT)
   ====================================================== */

let currentLang = "dk";

function setLang(lang) {
    currentLang = lang;
    document.documentElement.setAttribute("data-lang", lang);
}


/* ======================================================
   AFSNIT 14 ‚Äì THEME SWITCH
   ====================================================== */

function toggleTheme() {
    const current = document.documentElement.getAttribute("data-theme");
    const next = current === "light" ? "dark" : "light";
    document.documentElement.setAttribute("data-theme", next);
    localStorage.setItem("theme", next);
}

function initTheme() {
    const saved = localStorage.getItem("theme") || "dark";
    document.documentElement.setAttribute("data-theme", saved);
}


/* ======================================================
   AFSNIT 15 ‚Äì SLET OPGAVE POPUP (NYT)
   ------------------------------------------------------
   15.1 ‚Äì √Öbn popup
   15.2 ‚Äì Luk popup
   15.3 ‚Äì Bekr√¶ft og slet
   15.4 ‚Äì Opret popup-element automatisk i DOM
   ====================================================== */


/* 15.1 ‚Äì VIS POPUP */
function showDeletePopup(planId) {
    const overlay = document.getElementById("deleteModalOverlay");
    const btn = document.getElementById("confirmDeleteBtn");
    if (!overlay || !btn) return;

    btn.dataset.planId = planId;
    overlay.classList.add("visible");
}

/* 15.2 ‚Äì LUK POPUP */
function closeDeletePopup() {
    const overlay = document.getElementById("deleteModalOverlay");
    if (overlay) overlay.classList.remove("visible");
}

/* 15.3 ‚Äì SLET OPGAVE */
function confirmDeleteAction() {
    const btn = document.getElementById("confirmDeleteBtn");
    if (!btn) return;

    const id = btn.dataset.planId;
    if (!id) return;

    deletePlanItem(id);
    closeDeletePopup();
}

/* 15.4 ‚Äì OPRET POPUP AUTOMATISK */
(function createDeleteModal() {
    if (document.getElementById("deleteModalOverlay")) return;

    const div = document.createElement("div");
    div.id = "deleteModalOverlay";
    div.className = "modal-overlay";

    div.innerHTML = `
        <div class="modal-box">
            <div class="modal-title">Bekr√¶ft sletning</div>
            <div class="modal-message">Vil du slette denne opgave?</div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="cancelDeleteBtn">Fortryd</button>
                <button class="modal-btn modal-btn-delete" id="confirmDeleteBtn">Slet</button>
            </div>
        </div>
    `;

    document.body.appendChild(div);

    document.getElementById("cancelDeleteBtn")
        .addEventListener("click", closeDeletePopup);

    document.getElementById("confirmDeleteBtn")
        .addEventListener("click", confirmDeleteAction);
})();


/* ======================================================
   AFSNIT 16 ‚Äì STARTSIDE / DASHBOARD
   ====================================================== */

function initDashboard() {
    renderCustomers();
    renderEmployees();
    renderPlans();
    renderCalendar();
}


/* ======================================================
   AFSNIT 17 ‚Äì INIT APP (K√òRES √âN GANG)
   ====================================================== */

function initApp() {

    loadAll();
    initTheme();
    initDashboard();

    // Navigation links
    document.querySelectorAll("[data-page]").forEach(el => {
        el.addEventListener("click", () => {
            const page = el.dataset.page;
            showPage(page);
        });
    });

    // Theme toggle knap
    const themeBtn = document.getElementById("themeToggle");
    if (themeBtn) themeBtn.addEventListener("click", toggleTheme);

    // Opret opgave
    const addPlanBtn = document.getElementById("addPlanBtn");
    if (addPlanBtn) addPlanBtn.addEventListener("click", addPlan);
}


/* ======================================================
   AFSNIT 18 ‚Äì START APPEN
   ====================================================== */

document.addEventListener("DOMContentLoaded", initApp);
